<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fjellstad Kalender</title>
<style>
  body { font-family: Arial, sans-serif; background: #0a0e1a; color: #fff; margin:0; padding:0; }
  header { background: #111; padding: 1rem; display:flex; justify-content: space-between; align-items:center; }
  header h1 { margin:0; font-size:1.5rem; }
  button { cursor:pointer; padding:0.5rem 1rem; border:none; border-radius:5px; background:#4facfe; color:white; font-weight:bold; }
  .calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:#222; margin:1rem; }
  .day { background:#111; min-height:100px; padding:5px; display:flex; flex-direction:column; justify-content:flex-start; }
  .day-number { font-weight:bold; margin-bottom:0.3rem; }
  .event { background:#4facfe; padding:2px 4px; margin-bottom:2px; border-radius:3px; font-size:0.8rem; cursor:pointer; }
  .event:hover { background:#67aaff; }
  .weekdays { display:grid; grid-template-columns: repeat(7, 1fr); background:#222; text-align:center; }
  .weekday { padding:5px 0; font-weight:bold; }
  #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
  #modalContent { background:#111; padding:2rem; border-radius:10px; max-width:400px; width:90%; }
  #comments { max-height:200px; overflow-y:auto; margin-top:1rem; border-top:1px solid #333; padding-top:0.5rem; }
  .comment { margin-bottom:0.5rem; font-size:0.9rem; }
  input, textarea { width:100%; margin-top:0.5rem; padding:5px; border-radius:5px; border:none; }
</style>
</head>
<body>

<header>
  <h1>Fjellstad Kalender</h1>
  <button id="discordLogin">Logg inn med Discord</button>
</header>

<div class="weekdays">
  <div class="weekday">Søn</div>
  <div class="weekday">Man</div>
  <div class="weekday">Tir</div>
  <div class="weekday">Ons</div>
  <div class="weekday">Tor</div>
  <div class="weekday">Fre</div>
  <div class="weekday">Lør</div>
</div>

<div class="calendar" id="calendar"></div>

<!-- Modal for arrangement -->
<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>
    <div id="eventList"></div>
    <textarea id="commentInput" placeholder="Skriv kommentar..."></textarea>
    <button id="addCommentBtn">Legg til kommentar</button>
    <div id="comments"></div>
    <button onclick="closeModal()">Lukk</button>
  </div>
</div>

<script>
// === Discord Login Setup ===
const clientId = "DIN_CLIENT_ID"; // Sett din Client ID her
const redirectUri = "https://fjellstadrollespill.netlify.app/callback.html";
const scopes = "identify";

document.getElementById("discordLogin").onclick = () => {
  const url = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scopes}`;
  window.location.href = url;
}

async function getDiscordUser() {
  const token = localStorage.getItem("discord_token");
  if (!token) return null;
  try {
    const res = await fetch("https://discord.com/api/users/@me", {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Token ugyldig");
    const user = await res.json();
    return user;
  } catch (e) {
    console.error(e);
    return null;
  }
}

// === Calendar Setup ===
const calendarEl = document.getElementById("calendar");
const events = {
  "2025-12-25": [{ title: "Julefest" }],
  "2025-12-31": [{ title: "Nyttårsaften" }]
};
const commentsStore = JSON.parse(localStorage.getItem("comments")||"{}");

function renderCalendar() {
  calendarEl.innerHTML = "";
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month+1, 0);
  const startDay = firstDay.getDay(); // 0=sun,6=sat

  // Blank days
  for(let i=0;i<startDay;i++){
    const blank = document.createElement("div");
    blank.className="day";
    calendarEl.appendChild(blank);
  }

  // Days
  for(let d=1; d<=lastDay.getDate(); d++){
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayEl = document.createElement("div");
    dayEl.className="day";
    const numberEl = document.createElement("div");
    numberEl.className="day-number";
    numberEl.textContent = d;
    dayEl.appendChild(numberEl);

    // Add events
    if(events[dateStr]){
      events[dateStr].forEach((ev,i)=>{
        const evEl = document.createElement("div");
        evEl.className="event";
        evEl.textContent = ev.title;
        evEl.onclick = () => openModal(dateStr, ev.title);
        dayEl.appendChild(evEl);
      });
    }

    calendarEl.appendChild(dayEl);
  }
}

// === Modal ===
const modal = document.getElementById("modal");
const modalDateEl = document.getElementById("modalDate");
const eventListEl = document.getElementById("eventList");
const commentsEl = document.getElementById("comments");
let currentDate="";
let currentEvent="";

function openModal(date, eventTitle) {
  currentDate = date;
  currentEvent = eventTitle;
  modal.style.display="flex";
  modalDateEl.textContent = `${date} - ${eventTitle}`;
  renderComments();
}

function closeModal() { modal.style.display="none"; }

function renderComments(){
  commentsEl.innerHTML="";
  const allComments = commentsStore[currentDate+"_"+currentEvent] || [];
  allComments.forEach(c=>{
    const div = document.createElement("div");
    div.className="comment";
    div.innerHTML=`<strong>${c.username}:</strong> ${c.text}`;
    commentsEl.appendChild(div);
  });
}

document.getElementById("addCommentBtn").onclick = async ()=>{
  const user = await getDiscordUser();
  if(!user) return alert("Du må logge inn med Discord først!");
  const text = document.getElementById("commentInput").value;
  if(!text) return;
  const key = currentDate+"_"+currentEvent;
  if(!commentsStore[key]) commentsStore[key]=[];
  commentsStore[key].push({username:user.username,text});
  localStorage.setItem("comments",JSON.stringify(commentsStore));
  document.getElementById("commentInput").value="";
  renderComments();
}

// === Initial render ===
renderCalendar();
</script>

</body>
</html>
